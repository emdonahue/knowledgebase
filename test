#!/bin/zsh

assert() {
    if [[ $# == 1 || "$2" != "$3" ]]; then
	echo "Failure: $1"
	ERR=1
	if [[ "$2" != "$3" ]]; then echo "\tExpected: $3\n\tReceived: $2"; fi
    fi
}

function teardown() {
    cd "$DIR"
    rm -rf inbox md5 text notes bib
}

AMD5=$(md5sum <<< 'a' | cut -f1 -d' ')
BMD5=$(md5sum <<< 'b' | cut -f1 -d' ')

KB=$(realpath ./kb)
DIR=$(mktemp -d)
trap "rm -rf $DIR" EXIT
cd "$DIR"

assert 'bad file structure' "$($KB import 2>&1)" 'kb directory structure not detected. Use "kb init" to create a new directory structure.'

$KB init
echo 'a' > inbox/a.pdf
echo 'b' > inbox/b.txt
echo 'z' > md5/$AMD5.pdf

#import
$KB import
[[ -f inbox/a.pdf ]] && assert 'import inbox a'
[[ -f inbox/b.txt ]] && assert 'import inbox b'
[[ -f md5/$AMD5.pdf ]] || assert 'import m5d a'
[[ -f md5/$BMD5.txt ]] || assert 'import m5d b  '
[[ -f bib/$AMD5.bib ]] || assert 'import bib a'
[[ -f bib/$BMD5.bib ]] || assert 'import bib b'
[[ -f notes/$AMD5.org ]] || assert 'import org a'
assert 'import org link' "$(head -n1 notes/$AMD5.org)" '[[file:../md5/'"$AMD5"'.pdf][a]]'
[[ -f notes/$BMD5.org ]] || assert 'import org b'
assert 'import bib' "$(cat bib/$AMD5.bib)" "$(echo '@article{'"$AMD5"',\ntitle={a},\n}')"

#md5
assert 'md5' "$($KB md5)" "$(echo "$BMD5\n$AMD5")"

#ls
#assert 'ls' "$($KB ls)" "$(echo 'b\na')"



[[ -z "$ERR" ]] && echo "All Tests Pass"
exit "$ERR"
